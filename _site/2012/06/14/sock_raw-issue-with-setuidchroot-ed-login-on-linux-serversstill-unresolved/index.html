<!DOCTYPE html>
<html lang="en">
<head>
  <title>John Duff - SOCK_RAW Issue with setuid&chroot-ed login on Linux Servers(Still Unresolved) </title>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="verify-v1" content="fI45uNHehVNiO9Dt0Fp7XnsV0Z/ozBTkPoS6RlYAe50=" />
  <meta name="y_key" content="6c948e75a617b12d" />
  <meta name='technorati-claim' content='8QN7CWNH8BSJ' />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" media="screen" href="/css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="/css/default.css" />
  <link rel="stylesheet" type="text/css" href="/css/syntax.css" />
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="John Duff's blog" />
</head>

<body class='blog'>
  <div class="container">
    <div class="row">
      <div class="span4 sidebar affix">
        <div class="well">
          <h2 class='site-title'>
            <a href="http://bo-yang.github.io">Bo Yang</a>
          </h2>

		  <p><i>You got to make the back of the fence that nobody will see just as good looking as the front of the fence.</i></p>

          <ul id="navigation" class="clearfix">
            <li class='about'><a href='/about/'>About</a></li>
            <li class='archives'><a href='/archives/'>Archives</a></li>
            <li class="github"><a href="http://github.com/bo-yang" rel='me' class='url'>@github</a></li>
          </ul>
        </div>
      </div>
      <div class="span8 main offset4">
        <div class="well">
          <div class="post">
    <h1>SOCK_RAW Issue with setuid&chroot-ed login on Linux Servers(Still Unresolved)</h1>
    <p>Problem:</p>
<blockquote><p>when using function socket(AF_INET,<strong>SOCK_RAW</strong>,IPPROTO_TCP...) with setuid&amp;chroot-ed fake root on Linux servers, it would always fail. However, the real root can work well. Usually the fake root can do most things that root login required.
</p></blockquote>
<p>After investigation, got following hints:</p>
<ul>
<li>According to man page of <a href="http://linux.die.net/man/7/raw">SOCK_RAW(7)</a>, &quot;Only processes with an effective user ID of 0 or the CAP_NET_RAW capability are allowed to open raw sockets&quot;.</li>
<li>According to <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/capabilities.7.html">capabilities(7) - Linux man page</a>, &quot;For the purpose of performing permission checks, traditional UNIX implementations distinguish two categories of processes: privileged processes (whose effective user ID is 0, referred to as superuser or root), and unprivileged processes (whose effective UID is nonzero). Privileged processes bypass all kernel permission checks, while unprivileged processes are subject to full permission checking based on the process's credentials (usually: effective UID, effective GID, and supplementary group list)&quot;.</li>
</ul>
<blockquote><p>Starting with kernel 2.2, Linux divides the privileges traditionally associated with superuser into distinct units, known as capabilities, which can be independently enabled and disabled. Capabilities are a per-thread attribute.
</p></blockquote>
<blockquote><p>CAP_NET_RAW
</p></blockquote>
<blockquote><blockquote> Use RAW and PACKET sockets.</p>
</blockquote>
</blockquote>
<ul>
<li>In raw socket access as normal user on linux 2.4, setuid is suggested, but it didnâ€™t work.</li>
</ul>
<p>Since we can't provide root login to all users, we must either find a way to let raw sockets work with setuid&amp;chroot-ed login, or substitute raw sockets with other options.</p>

</div>

<small class="meta">Posted June 14, 2012</small>

<div id="comments">
  <h3>Comments</h3>

  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'johnduff';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        </div>
      </div>

      <div id="bottom" class="span8 offset4">
        <div class="well">
          <a href="/about/">About</a> |
          <a href="/archives/">Archives</a> |
          <a href="/atom.xml">feed</a>
        </div>
      </div>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/bootstrap.min.js"></script>

  <!-- Google Analytics Code -->
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-9947336-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 
          'http://www') + '.google-analytics.com/ga.js';
      ga.setAttribute('async', 'true');
      document.documentElement.firstChild.appendChild(ga);
    })();

  </script>
</body>
</html>

