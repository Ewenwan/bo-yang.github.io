<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Click Notes I - Overview &#8211; Bo's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Bo&#39;s blog.">
    <meta name="author" content="Bo Yang">
    <meta name="keywords" content="Notes, Network">
    <link rel="canonical" href="http://www.bo-yang.net//2014/12/23/click-notes-overview">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Bo's Blog" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201602041743" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Google Prettify -->
    <link href="http://www.bo-yang.net//assets/google-code-prettify/desert.css" rel="stylesheet" type="text/css" media="all">

    <!-- MathJax -->
    
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    

    <!-- Verifications -->
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Click Notes I - Overview">
    <meta property="og:description" content="Bo&#39;s blog.">
    <meta property="og:url" content="http://www.bo-yang.net//2014/12/23/click-notes-overview">
    <meta property="og:site_name" content="Bo&#39;s Blog">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@bonnyang" />
    
    <meta name="twitter:title" content="Click Notes I - Overview" />
    <meta name="twitter:description" content="Bo's blog." />
    <meta name="twitter:url" content="http://www.bo-yang.net//2014/12/23/click-notes-overview" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-50551633-1', 'auto');
       ga('send', 'pageview');
    </script>
    
</head>

<body class="site">

	
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5&appId=";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
        <a href="http://www.bo-yang.net/" class="site-title"><b>Bo's Blog</b></a>
      <nav class="site-nav">
        
    

    

    
        <a href="/archive/">Archive</a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


    

    

    

    

    

    

    

    
        <a href="/tags/">Tags</a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


    

    
        <a href="/about/">About Me</a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


    

    

    

    
        <a href="/contact/">Contact</a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/bo-yang"></a>
    
    
    
      <a class="fa fa-stack-overflow" href="https://stackoverflow.com/users/boyang"></a>
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/bonnyang"></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:bonny95@gmail.com"></a>
    
    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/in/boyanglink"></a>
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Click Notes I - Overview</h1>
  <span class="post-meta">Dec 23, 2014</span><br>
  
  <span class="post-meta small">
  
    10 minute read
  
  </span>
</div>

<article class="post-content">
  <p><a href="http://www.read.cs.ucla.edu/click/click">Click</a> is a modular router toolkit written mainly in C++, which can be run in both user space and OS kernel space. Since its invention in late 1990s by Eddie Kohler, Click is has gained great successes in both research and industry. This series of notes aims to (1)introduce Click platform, (2)analyze the implementation of Click, and (3) discuss some general problems related to Operating System and Network Programming. The Click Source code can be found <a href="https://github.com/kohler/click/">here</a>.</p>

<ol>
  <li><a href="#router_model">Router Models</a></li>
  <li><a href="#click_arch">Click Architecture</a></li>
  <li><a href="#element">Elements</a></li>
  <li><a href="#packet">Packets</a></li>
  <li><a href="#connect">Connections</a></li>
  <li><a href="#ref">References</a></li>
</ol>

<h3 id="a-nameroutermodelrouter-modelsa"><a name="router_model">Router Models</a></h3>
<p>Click was developed based on an abstract router model. Routers are viewed as pure packet processors: packets arrive on one network interface, travel through the packet processor’s forwarding path, and are emitted on another network interface. In routers, packets flow through the forwarding paths, which behave just like the pipelines. Packets will lose their identity after they arrive the target - only data will be transferred to applications(running on host). One significant differences between routers and hosts is: in packet processors, packets move horizontally between peers, not vertically between application layers.</p>

<p>Click also used an important observation - the packet operation is be basis of computer networks. Firewall limits access to a protected network, often by dropping inappropriate packets. Network address translators allow a large set of machines to share a single public IP address; they work by rewriting packet headers, and occasionally some data. Load balancers send packets to one of a set of servers, dynamically choosing a server based on load or some application characteristic. Therefore, most Click elements center on packet operations.</p>

<h3 id="a-nameclickarchclick-architecturea"><a name="click_arch">Click Architecture</a></h3>

<p>The Click architecture is centered on the element. Each element is a software component representing a unit of router processing, which generally examines or modifies packets in some way. At run time, elements pass packets to one another over links called connections. Each connection represents a possible path for packet transfer. A router configuration is a directed graph with elements at the vertices and connections as the edges. Router configurations, run in the context of some driver, either at user level or in the Linux kernel.</p>

<p>A Click router is assembled from packet processing modules called elements. Individual elements implement simple router functions like packet classification, queueing, scheduling, and interfacing with network devices. Configurations are written in a declarative language that supports user-defined abstractions. Due to Click’s architecture and language, Click router configurations are modular and easy to extend. To build a router configuration, Click users can choose a collection of elements and connects them into a directed graph.</p>

<p>In addition to the modular router, Click also supports a configuration scripting language and provides an interpreter, which are also written in C++. Click supports multiple processros and has a builtin scheduler for tasks(elements). These topics will be covered in the future posts.</p>

<h3 id="a-nameelementelementsa"><a name="element">Elements</a></h3>

<p>Elements have five important properties: element class, ports, configuration strings, method interfaces and handlers.</p>

<p><img src="http://www.bo-yang.net//assets/images/click_notes/click_element.png" alt="Click Connections" /></p>

<ul>
  <li><em>Element class</em>. An element’s class specifies that element’s data layout and behavior.</li>
  <li><em>Ports</em>. Each element can have any number of input and output ports. Every connection links an output port on one element to an input port on another. Ports may be push, pull, or agnostic.</li>
  <li><em>Configuration string</em>. optional, contains additional arguments passed to the element at router initialization time. Lexically, a configuration string is a list of arguments separated by commas, i.e. <code class="highlighter-rouge">c1 :: Classifier(9/17, 9/6, -);</code>.</li>
  <li><em>Method interfaces</em>. Each element exports methods that other elements may access. This set of methods is grouped into method interfaces.</li>
  <li><em>Handlers</em>. Handlers are methods that are exported to the user, rather than to other elements in the router configuration. They support text-based read/write semantics, as opposed to fully general method call semantics. In the Linux kernel driver, handlers appear as files in the dynamic <code class="highlighter-rouge">/proc</code> file system.</li>
</ul>

<p>An example of real Click element is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="cp">#ifndef CLICK_SWITCH_HH
</span>    <span class="cp">#define CLICK_SWITCH_HH
</span>    <span class="cp">#include &lt;click/element.hh&gt;
</span>    <span class="n">CLICK_DECLS</span>
    
    <span class="k">class</span> <span class="nc">Switch</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Element</span> <span class="p">{</span> <span class="k">public</span><span class="o">:</span>
    
      <span class="n">Switch</span><span class="p">()</span> <span class="n">CLICK_COLD</span><span class="p">;</span>
    
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">class_name</span><span class="p">()</span> <span class="k">const</span>		<span class="p">{</span> <span class="k">return</span> <span class="s">"Switch"</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port_count</span><span class="p">()</span> <span class="k">const</span>		<span class="p">{</span> <span class="k">return</span> <span class="s">"1/-"</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">processing</span><span class="p">()</span> <span class="k">const</span>		<span class="p">{</span> <span class="k">return</span> <span class="n">PUSH</span><span class="p">;</span> <span class="p">}</span>
      <span class="kt">void</span> <span class="n">add_handlers</span><span class="p">()</span> <span class="n">CLICK_COLD</span><span class="p">;</span>
    
      <span class="kt">int</span> <span class="n">configure</span><span class="p">(</span><span class="n">Vector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="o">*</span><span class="p">)</span> <span class="n">CLICK_COLD</span><span class="p">;</span>
      <span class="n">bool</span> <span class="n">can_live_reconfigure</span><span class="p">()</span> <span class="k">const</span>		<span class="p">{</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
    
      <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">Packet</span> <span class="o">*</span><span class="p">);</span>
    
      <span class="kt">int</span> <span class="n">llrpc</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
    
     <span class="k">private</span><span class="o">:</span>
    
      <span class="kt">int</span> <span class="n">_output</span><span class="p">;</span>
    
      <span class="k">static</span> <span class="n">String</span> <span class="n">read_param</span><span class="p">(</span><span class="n">Element</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">CLICK_COLD</span><span class="p">;</span>
      <span class="k">static</span> <span class="kt">int</span> <span class="n">write_param</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">Element</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="o">*</span><span class="p">)</span> <span class="n">CLICK_COLD</span><span class="p">;</span>
    
    <span class="p">};</span>
    
    <span class="n">CLICK_ENDDECLS</span>
    <span class="cp">#endif
</span></code></pre>
</div>

<p>In above code, the Click macros are defined as:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="cm">/* Define macros that surround Click declarations. */</span>
    <span class="cp">#define CLICK_DECLS		namespace Click {
</span>    <span class="cp">#define CLICK_ENDDECLS		}
</span>    
    <span class="cm">/* Define macro for cold (rarely used) functions. */</span>
    <span class="cp">#if __GNUC__ &lt; 4 || (__GNUC__ == 4 &amp;&amp; __GNUC_MINOR__ &lt; 3)
</span>    <span class="cp"># define CLICK_COLD </span><span class="cm">/* nothing */</span><span class="cp">
</span>    <span class="cp">#else
</span>    <span class="cp"># define CLICK_COLD __attribute__((cold))
</span>    <span class="cp">#endif
</span></code></pre>
</div>

<p>Where the GNU <code class="highlighter-rouge">cold</code> attribute on functions is used to inform the compiler that the function is unlikely to be executed. The function is optimized for size rather than speed and on many targets it is placed into a special subsection of the text section so all cold functions appear close together, improving code locality of non-cold parts of program.</p>

<p>And the handlers of this element can be defined as:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="n">String</span>
    <span class="n">Switch</span><span class="o">::</span><span class="n">read_param</span><span class="p">(</span><span class="n">Element</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Switch</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="p">(</span><span class="n">Switch</span> <span class="o">*</span><span class="p">)</span><span class="n">e</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">String</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">_output</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kt">int</span>
    <span class="n">Switch</span><span class="o">::</span><span class="n">write_param</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">Element</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="o">*</span><span class="n">errh</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Switch</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="p">(</span><span class="n">Switch</span> <span class="o">*</span><span class="p">)</span><span class="n">e</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">sw_output</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IntArg</span><span class="p">().</span><span class="n">parse</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sw_output</span><span class="p">))</span>
    	<span class="k">return</span> <span class="n">errh</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">(</span><span class="s">"Switch output must be integer"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sw_output</span> <span class="o">&gt;=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">noutputs</span><span class="p">())</span>
    	<span class="n">sw_output</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">sw</span><span class="o">-&gt;</span><span class="n">_output</span> <span class="o">=</span> <span class="n">sw_output</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kt">void</span>
    <span class="n">Switch</span><span class="o">::</span><span class="n">add_handlers</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">add_read_handler</span><span class="p">(</span><span class="s">"switch"</span><span class="p">,</span> <span class="n">read_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">add_write_handler</span><span class="p">(</span><span class="s">"switch"</span><span class="p">,</span> <span class="n">write_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Handler</span><span class="o">::</span><span class="n">h_nonexclusive</span><span class="p">);</span>
        <span class="n">add_read_handler</span><span class="p">(</span><span class="s">"config"</span><span class="p">,</span> <span class="n">read_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">set_handler_flags</span><span class="p">(</span><span class="s">"config"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Handler</span><span class="o">::</span><span class="n">CALM</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>By adding handlers to element <code class="highlighter-rouge">Switch</code>, the Switch attributes <code class="highlighter-rouge">switch</code> and <code class="highlighter-rouge">config</code> can be read or changed by reading/writing files <code class="highlighter-rouge">/proc/click/&lt;switch_obj&gt;/switch</code> and <code class="highlighter-rouge">/proc/click/&lt;switch_obj&gt;/config</code> at run time, if Click is running in Linux kernel.</p>

<h3 id="a-namepacketpacketsa"><a name="packet">Packets</a></h3>

<p>A Click Packet consists of a small packet header and the actual packet data – the packet header points to the data. In the Linux kernel driver, Click packet objects are equivalent to sk_buffs, which avoids translation or indirection overhead when communicating with device drivers or the kernel itself.</p>

<p>Several packet headers may share the same packet data. When copying a packet, Click produces a new packet header that shares the original data. Shared packet data is copy-on-write. Elements that modify packet data first ensure that it is unshared; if it is shared, the element will make a unique copy of the data and change the packet header to point to that copy. Packet headers are never shared, so header modifications never cause a copy.</p>

<p>Headers contain a number of annotations in addition to a pointer to the packet data. Some annotations contain information independent of the packet data - for example, the time when the packet arrived. Other annotations cache information about the data, i.e, the CheckIPHeader element sets the IP header annotation on passing IP packets.</p>

<p>In Linux, the sk_buff is defined as:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="p">{</span>
    	<span class="cm">/* These two members must be first. */</span>
    	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">next</span><span class="p">;</span>
    	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">prev</span><span class="p">;</span>
    
            <span class="err">…</span><span class="p">...</span>
    
    	<span class="n">ktime_t</span>			<span class="n">tstamp</span><span class="p">;</span>
    
    	<span class="k">struct</span> <span class="n">sock</span>		<span class="o">*</span><span class="n">sk</span><span class="p">;</span>
    	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
    
    	<span class="cm">/*
    	 * This is the control buffer. It is free to use for every
    	 * layer. Please put your private variables there. If you
    	 * want to keep them across layers you have to do a skb_clone()
    	 * first. This is owned by whoever has the skb queued ATM.
    	 */</span>
    <span class="cp">#ifdef __LP64__
</span>    	<span class="kt">char</span>			<span class="n">cb</span><span class="p">[</span><span class="mi">96</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    <span class="cp">#else
</span>    	<span class="kt">char</span>			<span class="n">cb</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    <span class="cp">#endif
</span>    
    	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">_skb_refdst</span><span class="p">;</span>
    <span class="cp">#ifdef CONFIG_XFRM
</span>    	<span class="k">struct</span>	<span class="n">sec_path</span>	<span class="o">*</span><span class="n">sp</span><span class="p">;</span>
    <span class="cp">#endif
</span>    	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">len</span><span class="p">,</span>
    				<span class="n">data_len</span><span class="p">;</span>
    	<span class="n">__u16</span>			<span class="n">mac_len</span><span class="p">,</span>
    				<span class="n">hdr_len</span><span class="p">;</span>
    	<span class="k">union</span> <span class="p">{</span>
    		<span class="n">__wsum</span>		<span class="n">csum</span><span class="p">;</span>
    		<span class="k">struct</span> <span class="p">{</span>
    			<span class="n">__u16</span>	<span class="n">csum_start</span><span class="p">;</span>
    			<span class="n">__u16</span>	<span class="n">csum_offset</span><span class="p">;</span>
    		<span class="p">};</span>
    	<span class="p">};</span>
    	<span class="n">__u32</span>			<span class="n">priority</span><span class="p">;</span>
    	<span class="n">kmemcheck_bitfield_begin</span><span class="p">(</span><span class="n">flags1</span><span class="p">);</span>
    	<span class="n">__u8</span>			<span class="n">local_df</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
    				<span class="n">cloned</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
    				<span class="n">ip_summed</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
    				<span class="n">nohdr</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
    				<span class="n">nfctinfo</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>
    	<span class="n">__u8</span>			<span class="n">pkt_type</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span>
    				<span class="n">fclone</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
    				<span class="n">ipvs_property</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
    				<span class="n">peeked</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
    				<span class="n">nf_trace</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
    	<span class="n">kmemcheck_bitfield_end</span><span class="p">(</span><span class="n">flags1</span><span class="p">);</span>
    	<span class="n">__be16</span>			<span class="n">protocol</span><span class="p">;</span>
    
    	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">destructor</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
            <span class="err">……</span><span class="p">..</span>
    
    	<span class="kt">int</span>			<span class="n">skb_iif</span><span class="p">;</span>
    
    	<span class="n">__u32</span>			<span class="n">rxhash</span><span class="p">;</span>
    
    	<span class="n">__u16</span>			<span class="n">vlan_tci</span><span class="p">;</span>
    
            <span class="err">……</span><span class="p">..</span>
    
    	<span class="n">sk_buff_data_t</span>		<span class="n">transport_header</span><span class="p">;</span>
    	<span class="n">sk_buff_data_t</span>		<span class="n">network_header</span><span class="p">;</span>
    	<span class="n">sk_buff_data_t</span>		<span class="n">mac_header</span><span class="p">;</span>
    	<span class="cm">/* These elements must be at the end, see alloc_skb() for details.  */</span>
    	<span class="n">sk_buff_data_t</span>		<span class="n">tail</span><span class="p">;</span>
    	<span class="n">sk_buff_data_t</span>		<span class="n">end</span><span class="p">;</span>
    	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">head</span><span class="p">,</span>
    				<span class="o">*</span><span class="n">data</span><span class="p">;</span>
    	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">truesize</span><span class="p">;</span>
    	<span class="n">atomic_t</span>		<span class="n">users</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre>
</div>

<p>The Click Packet is defined as:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="k">class</span> <span class="nc">Packet</span> <span class="p">{</span>
    <span class="err">…</span><span class="p">...</span>
    <span class="k">private</span><span class="o">:</span>
    
        <span class="c1">// Anno must fit in sk_buff's char cb[48].
</span>        <span class="cm">/** @cond never */</span>
        <span class="k">union</span> <span class="n">Anno</span> <span class="p">{</span>
    	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="n">anno_size</span><span class="p">];</span>
    	<span class="kt">uint8_t</span> <span class="n">u8</span><span class="p">[</span><span class="n">anno_size</span><span class="p">];</span>
    	<span class="kt">uint16_t</span> <span class="n">u16</span><span class="p">[</span><span class="n">anno_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
    	<span class="kt">uint32_t</span> <span class="n">u32</span><span class="p">[</span><span class="n">anno_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>
    <span class="cp">#if HAVE_INT64_TYPES
</span>    	<span class="kt">uint64_t</span> <span class="n">u64</span><span class="p">[</span><span class="n">anno_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">];</span>
    <span class="cp">#endif
</span>    	<span class="c1">// allocations: see packet_anno.hh
</span>        <span class="p">};</span>
    
    <span class="cp">#if !CLICK_LINUXMODULE
</span>        <span class="c1">// All packet annotations are stored in AllAnno so that
</span>        <span class="c1">// clear_annotations(true) can memset() the structure to zero.
</span>        <span class="k">struct</span> <span class="n">AllAnno</span> <span class="p">{</span>
    	<span class="n">Anno</span> <span class="n">cb</span><span class="p">;</span>
    	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
    	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nh</span><span class="p">;</span>
    	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
    	<span class="n">PacketType</span> <span class="n">pkt_type</span><span class="p">;</span>
    	<span class="n">Timestamp</span> <span class="n">timestamp</span><span class="p">;</span>
    	<span class="n">Packet</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    	<span class="n">Packet</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
    	<span class="n">AllAnno</span><span class="p">()</span>
    	    <span class="o">:</span> <span class="n">timestamp</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">uninitialized_t</span><span class="p">())</span> <span class="p">{</span>
    	<span class="p">}</span>
        <span class="p">};</span>
    <span class="cp">#endif
</span>        <span class="cm">/** @endcond never */</span>
    
    <span class="cp">#if !CLICK_LINUXMODULE
</span>        <span class="c1">// User-space and BSD kernel module implementations.
</span>        <span class="n">atomic_uint32_t</span> <span class="n">_use_count</span><span class="p">;</span>
        <span class="n">Packet</span> <span class="o">*</span><span class="n">_data_packet</span><span class="p">;</span>
        <span class="cm">/* mimic Linux sk_buff */</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_head</span><span class="p">;</span> <span class="cm">/* start of allocated buffer */</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_data</span><span class="p">;</span> <span class="cm">/* where the packet starts */</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_tail</span><span class="p">;</span> <span class="cm">/* one beyond end of packet */</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_end</span><span class="p">;</span>  <span class="cm">/* one beyond end of allocated buffer */</span>
    <span class="cp"># if CLICK_BSDMODULE
</span>        <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">_m</span><span class="p">;</span>
    <span class="cp"># endif
</span>        <span class="n">AllAnno</span> <span class="n">_aa</span><span class="p">;</span>
    <span class="err">…</span><span class="p">...</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>Obviously, both Linux <code class="highlighter-rouge">sk_buff</code> and Click <code class="highlighter-rouge">Packet</code> class have similiar elements, like hearder, data and tail of a packet.</p>

<h3 id="a-nameconnectconnectionsa"><a name="connect">Connections</a></h3>

<p>Each Click connection represents a possible path for packet transfer between elements. Connections are represented as pointers to element objects, and passing a packet along a connection is implemented by a single virtual function call(push or pull). Each connection links a source port to a destination port. The source port is always an output port, and the destination port is always an input port.</p>

<p>Connections link ports, but not elements. Each element may have many ports. If a path exists from an output port o to an input port i in the port graph representation of a router configuration, then we say that i is downstream of o, and conversely, that o is upstream of i.</p>

<p>Click supports two kinds of connections, push and pull. On a push connection, packets start at the source element and are passed downstream to the destination element. On a pull connection, in contrast, the destination element initiates packet transfer: it asks the source element to return a packet, or a null pointer if no packet is available. These packet transfers are implemented by two virtual function calls, push and pull.</p>

<p><img src="http://www.bo-yang.net//assets/images/click_notes/click_connections.png" alt="Click Connections" /></p>

<p>Connections between two push ports are push, and connections between two pull ports are pull. Connections between a push port and a pull port are illegal. For agnostic ports, they behave as push when connected to push ports and pull when connected to pull ports(Null elements in above picture). In the above picture, Queue element has a push input port and a pull output port - the input port respond to pushed packets by enqueueing them, and the output port responds to pull requests by dequeuing packets and returning them.</p>

<h3 id="a-namerefreferencesa"><a name="ref">References</a></h3>

<ul>
  <li><a href="http://pdos.csail.mit.edu/papers/click:kohler-phd/thesis.pdf">Eddie Kohler, <em>The Click modular router</em>, Ph.D. thesis, MIT, November 2000. This has more detail and examples than the TOCS and SOSP papers of the same name.</a></li>
  <li><a href="http://read.cs.ucla.edu/click/">http://read.cs.ucla.edu/click/</a></li>
  <li><a href="http://www.pats.ua.ac.be/software/click/">http://www.pats.ua.ac.be/software/click/</a></li>
  <li><a href="https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html">https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html</a></li>
</ul>

</article>


  <div class="share-page">
  <br>
  Share this post!

  <div class="share-links">
    
      <a class="fa fa-facebook" href="https://facebook.com/sharer.php?u=http://www.bo-yang.net//2014/12/23/click-notes-overview" rel="nofollow" target="_blank" title="Share on Facebook"></a>
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Click Notes I - Overview&url=http://www.bo-yang.net//2014/12/23/click-notes-overview" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    
      <a class="fa fa-google-plus" href="https://plus.google.com/share?url=http://www.bo-yang.net//2014/12/23/click-notes-overview" rel="nofollow" target="_blank" title="Share on Google+"></a>
    

    
      <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=http://www.bo-yang.net//2014/12/23/click-notes-overview&title=Click Notes I - Overview" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    

    

    
      <a class="fa fa-tumblr" href="http://www.tumblr.com/share/link?url=http://www.bo-yang.net//2014/12/23/click-notes-overview&name=Click Notes I - Overview" rel="nofollow" target="_blank" title="Share on Tumblr"></a>
    

    
      <a class="fa fa-reddit" href="http://reddit.com/submit?url=http://www.bo-yang.net//2014/12/23/click-notes-overview&title=Click Notes I - Overview" rel="nofollow" target="_blank" title="Share on Reddit"></a>
    

    

    
      <a class="fa fa-hacker-news" onclick="parent.postMessage('submit','*')" href="https://news.ycombinator.com/submitlink?u=http://www.bo-yang.net//2014/12/23/click-notes-overview&t=Click Notes I - Overview" rel="nofollow" target="_blank" title="Share on Hacker News"></a>
    
  </div>
</div>





<center><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Banner_728x90 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-4220046549022535"
     data-ad-slot="5852972202"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</center>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50551633-1', 'auto');
  ga('send', 'pageview');

</script>



  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname  = 'boyang';
    var disqus_identifier = '/2014/12/23/click-notes-overview';
    var disqus_title      = 'Click Notes I - Overview';

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



  <div class="fb-comments" data-href="http://www.bo-yang.net//2014/12/23/click-notes-overview" data-width="100%" data-numposts="10"></div>



  <h3 class="related-post-title">Related Posts</h3>
  
    <div class="post ml2">
      <a href="/2016/01/26/gen-hex-dump" class="post-link">
        <h4 class="post-title">Generate Wireshark-Understandable Hexdump</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2015/08/31/centos7-install-tftp-server" class="post-link">
        <h4 class="post-title">A Complete Guide For Installing TFTP Server In CentOS 7</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2015/08/20/linux-system-log-2" class="post-link">
        <h4 class="post-title">How To Use Local Facilities For Logging?</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2015/05/27/retrieve-last-log" class="post-link">
        <h4 class="post-title">Retrieve Last Log After Crash</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2015/04/02/customize-linux-system-log-timestamp" class="post-link">
        <h4 class="post-title">Customizing OpenWRT System Log Timestamp</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2015/03/30/debug-kernel-space-memory-leak" class="post-link">
        <h4 class="post-title">Debug Kernel Space Memory Leak</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2015/01/12/linux-system-log" class="post-link">
        <h4 class="post-title">Linux System Log</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2015/01/07/click-notes-click-language" class="post-link">
        <h4 class="post-title">Click Notes II - Click Script Language</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2014/12/19/remote-local-linux-develop-env-2" class="post-link">
        <h4 class="post-title">Building Remote+Local *nix Develop Environment(II)</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2014/11/20/pthread_exit-in-main" class="post-link">
        <h4 class="post-title">Be careful to pthread_exit() in main()</h4>
        <p class="post-summary"></p>
      </a>
    </div>
  


      </div>
    </div>
  </div>

  <footer class="center">
    <div class="measure">
        <small>
            <p>&copy; 2007-2016 by <a href="http://www.bo-yang.net/">Bo Yang</a>. &nbsp; <script type="text/javascript" src="//rc.revolvermaps.com/0/0/3.js?i=493pvkdo4nt&amp;b=0&amp;s=20&amp;m=2&amp;cl=ffffff&amp;co=010020&amp;cd=aa0000&amp;v0=60&amp;v1=60&amp;r=1" async="async"></script>
 </p>

            <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> and <a href="https://github.com/johnotander/pixyll">Pixyll</a>.</p>
        </small>
    </div>
</footer>

</body>
</html>
