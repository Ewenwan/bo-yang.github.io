
<!DOCTYPE HTML>
<html lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:wb="http://open.weibo.com/wb">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Implementing Inclusion Property with SimpleScalar | Bo's Blog</title>
  
  <meta name="author" content="Bo Yang" />
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <!--
  <link href="/assets/themes/clear/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  -->

  <!-- Bootstrap -->
  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">

  <!-- font-awesome -->
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">

  <!-- Google Prettify -->
  <link href="/assets/google-code-prettify/desert.css" rel="stylesheet" type="text/css" media="all">
  <!-- Google Pretty end -->

  <link href="/assets/style/blog.css" rel="stylesheet">
  
  <script src="/assets/bootstrap/js/jquery-1.10.2.js"></script>
  <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>

<body>

   <!-- navigation bar -->
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
				<a class="navbar-brand" href="/"><b>bo-yang</b></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">
					<li><a href="/archive.html"><b>Archive</b></a>
					</li>
					<li><a href="/tags.html"><b>Tags</b></a>
                    </li>
                    <li><a href="/about.html"><b>About</b></a>
                    </li>
                    <li><a href="/messages.html"><b>Messages</b></a>
                    </li>
				</ul>
				<ul class="nav navbar-nav pull-right">
		          <li>
		            <form class="navbar-form navbar-search" method="get" action="http://www.google.com/search" target="google_window">
		              <input id="g_search" type="text" class="search-query" placeholder="Search..." name="q" />
		              <input type="submit" name="btnG" style="display:none" id="searchsubmit" value="Search" />
		              <input type="hidden" name="ie" value="UTF-8" />
		              <input type="hidden" name="oe" value="UTF-8" />
		              <input type="hidden" name="hl" value="en-US" />
		              <input type="hidden" name="domains" value="http://bo-yang.github.io/" />
					  <input type="hidden" name="sitesearch" value="http://bo-yang.github.io/" />
					  <button type="submit" class="button button-rounded button-flat-blue">Go</button>
		            </form>
		          </li>
		        </ul>
            </div>
			<!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

  <div class="container">
    <div class="row" id="content-row">
      
<div class="page-header">
	<h1>Implementing Inclusion Property with SimpleScalar</h1>
	<p>
		<span class="glyphicon glyphicon-time"></span> Posted at &nbsp; 2014-04-18 &nbsp; &nbsp; by  <a href="/about.html"><strong>Bo Yang</strong></a> &nbsp; &nbsp; <span class="glyphicon glyphicon-tag"></span><a href="/tags.html#Architecture-ref" rel="nofollow">Architecture</a>, <span class="glyphicon glyphicon-tag"></span><a href="/tags.html#C/C++-ref" rel="nofollow">C/C++</a>
	</p>
</div>

<div class="col-lg-10">
	<div class="post paper">
		<ol>
  <li><a href="#inclusion_property">Inclusion Property</a></li>
  <li><a href="#code_change">Code Change</a></li>
  <li><a href="#experiments">Experiments</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ol>

<h3 id="a-nameinclusionpropertyinclusion-propertya">1. <a name="inclusion_property">Inclusion Property</a></h3>

<p>If the two-level cache system satisfies the inclusion property, it means everything in the primary cache is also in the secondary cache and all snooping can be done by the secondary cache. To implement the inclusion property, two requirements must be met:</p>

<ul>
  <li>Whenever a new block of data are loaded into(or removed from) L1 cache, they also should be loaded into(or removed from) the L2 cache.</li>
  <li>Whenever a block of data are loaded into(or removed from) L2 cache, they also should be loaded into(or removed from) the L1 cache.</li>
</ul>

<p><em>SimpleScalar</em> already implemented the first requirement. When there is a cache miss in L1 cache, L2 cache will be accessed for the block. If the block are also cannot be found in the L2 cache, they will be loaded from the memory. The data consistency is kept in this way.</p>

<p>However, the second requirement is not supported by the official SimpleScalar. To implement this feature, the data block must be checked every time L2 cache encounter a cache miss. Since all cache read/write operations are done in function cache_access(), the action of checking and removing data blocks from L1 cache should also be added into that function with the condition of accessing L2 cache.</p>

<h3 id="a-namecodechangecode-changea">2. <a name="code_change">Code Change</a></h3>

<p>Since there is no existing way in cache_t to find the upper level cache(DL1) of the DL2 cache, a new structure element </p>

<p><code>struct cache_t *ucp;		/* upper level cache */</code></p>

<p>should be added into struct cache_t. This pointer should be set to NULL in function cache_create() if the cache name is not “dl2”. Otherwise the pointer to DL1 cache should be assigned.</p>

<p>To support the new added struct element, a new parameter </p>

<p><code>struct cache_t *ucp;		/* upper level cache */</code></p>

<p>should also be added into function cache_create(), which is called in sim-cache.c and sim-outorder.c. The new interface of this function becomes:</p>

<pre><code>/* create and initialize a general cache structure */
struct cache_t *			/* pointer to cache created */
cache_create(char *name,		/* name of the cache */
	     int nsets,			/* total number of sets in cache */
	     int bsize,			/* block (line) size of cache */
	     int balloc,		/* allocate data space for blocks? */
	     int usize,			/* size of user data to alloc w/blks */
	     int assoc,			/* associativity of cache */
	     enum cache_policy policy,	/* replacement policy w/in sets */
	     /* block access function, see description w/in struct cache def */
	     unsigned int (*blk_access_fn)(enum mem_cmd cmd,
					   md_addr_t baddr, int bsize,
					   struct cache_blk_t *blk,
					   tick_t now),
	     unsigned int hit_latency,/* latency in cycles for a hit */
	     struct cache_t *ucp);	/* upper level cache */
</code></pre>

<p>For DL2 cache, the pointer ucp is set to cache_dl1 in sim-cache.c in function cache_create(). For other cache, NULL is set. For example:</p>

<pre><code>cache_dl2 = cache_create(name, nsets, bsize, /* balloc */FALSE,
				   /* usize */0, assoc, cache_char2policy(c),
				   dl2_access_fn, /* hit latency */1,cache_dl1);
</code></pre>

<p>As checking and removing blocks from DL1 only involves DL1 and DL2 cache, all the operations can be encapsulated in a function cache_inclusion(). This function is called after blocks moved out from DL2 in the case of cache miss. Then check every block of DL1 in DL2: if the block can be found in DL2, keep it; it the block cannot be found in DL2, it means this block should be moved out of cache, so flush this block in DL1 to guarantee the inclusion property.</p>

<pre><code>/*
 * Inclusion Property:
 * 	Make sure data leave DL2 also leave DL1 
 * */
int cache_inclusion(struct cache_t *cp_l1, /* L1 cache */
		struct cache_t *cp_l2, /* L2 cache */
		tick_t now)		/* time of access */
{

	/* Loop through each set and each block in the L1 cache, 
	 * probe the L2 cache to guaranttee the inclusion */
	int num_l1_sets = cp_l1-&gt;set_mask + 1;
	int set;
  	struct cache_blk_t *blk;
	md_addr_t addr;
	int hindex;
	int num_hash_buckets = cp_l1-&gt;hsize;
	int there; /* indicates if the L1 line is in L2 */
	int lat=0;

	/* for each set */
	for(set=0; set&lt;num_l1_sets; set++){
		/* for each block in a higly-associativity cache*/
  		if (num_hash_buckets){
			/* for each hash bucket */
			for(hindex=0; hindex&lt;num_hash_buckets; hindex++){
			    /* for each block in a hash bucket */
			    for (blk=cp_l1-&gt;sets[set].hash[hindex];
				 blk;
				 blk=blk-&gt;hash_next)
				{	
					/* Probe the L2 cache for this block */
					addr = CACHE_MK_BADDR(cp_l1, blk-&gt;tag, set);
					there = cache_probe(cp_l2, addr);
					if(!there){ // line in DL1 but not in DL2
						lat += cache_flush_addr(cp_l1,addr,now);
						//fprintf(stderr, "\nEvict address %x from DL1!\n", addr);
					}
		   		}/* end for block in a bucket */
			}/* end for each bucket */
  		}/* end if highly associative cache*/

		/* for each block in a low-associativity cache*/
		else {
			for (blk=cp_l1-&gt;sets[set].way_head;
			 blk;
			 blk=blk-&gt;way_next)
    		{
				/* Probe the L2 cache for this block */
				addr = CACHE_MK_BADDR(cp_l1, blk-&gt;tag, set);
				there = cache_probe(cp_l2, addr);
				if(!there){ // line in DL1 but not in DL2
					lat += cache_flush_addr(cp_l1,addr,now);
					//fprintf(stderr, "\nEvict address %x from DL1!\n", addr);
				}
		    }/* end for */
  		}/* end for each block */
	}/* end for each set */
	
	return lat;
}
</code></pre>

<p>This function should be called in cache_access() after removing blocks from DL2. The basic idea of the above function is to  check every block of DL1 in DL2: if the block can be found in DL2, keep it; it the block cannot be found in DL2, it means this block should be moved out of cache, so flush this block in DL1 to guarantee the inclusion property.</p>

<p>The code segment for calling cache_inclusion() in cache_access() is:
	/* cache block not found */</p>

<pre><code> /* **MISS** */
 cp-&gt;misses++;
…...

/* link this entry back into the hash table */
  if (cp-&gt;hsize)
    link_htab_ent(cp, &amp;cp-&gt;sets[set], repl);

  /* Inclusion property:
   * 	Make sure data leave DL2 also leave DL1, or vice versa */
  if(!mystricmp(cp-&gt;name,"dl2") &amp;&amp; cp-&gt;ucp != NULL) 
  {
  	lat += cache_inclusion(cp-&gt;ucp,cp,now);
  }

  /* return latency of the operation */
  return lat;
</code></pre>

<h3 id="a-nameexperimentsexperimentsa">3. <a name="experiments">Experiments</a></h3>

<p>In my experiment, three benchmarks are used: gcc, mcf and vpr. For each benchmark, three different configurations are tested, which are the same as the three commands listed in the project requirement. Compared to the SimpleScalar without inclusion property, it took 2 times longer time after implementing the inclusion property. </p>

<p>After implementing inclusion property, the miss rates of DL1 generally increase a little, while the miss rates of DL2 decrease or keep the same. This is consistent with the code change, because due to inclusion property, statistically fewer data can be stored in DL1, but more valid data can be stored in DL2 cache. </p>

<p><img src="/assets/images/2014-04-18-inclusion-property/dl1.jpg" alt="Miss rate of DL1" /></p>

<p>Figure 1. Miss rate of DL1, with(red) and without(blue) inclusion.</p>

<p><img src="/assets/images/2014-04-18-inclusion-property/dl2.jpg" alt="Miss rate of DL2" /></p>

<p>Figure 2. Miss rate of DL2, with(red) and without(blue) inclusion.</p>

<h3 id="a-nameconclusionconclusiona">4. <a name="conclusion">Conclusion</a></h3>

<p>In this project I implemented the inclusion property with SimpleScalar. I tested my change with three different benchmarks in three different configurations. Experiments show proves the correctness of my change. Inclusion property cannot guarantee the overall performance the cache, although it seems like a promising technique.</p>

	</div>

	<div align="right">
        <div class="bshare-custom">
	<span class='st_facebook_large' displayText='Facebook'></span>
	<span class='st_googleplus_large' displayText='Google +'></span>
	<span class='st_twitter_large' displayText='Tweet'></span>
	<span class='st_sina_large' displayText='Sina'></span>
	<span class='st_linkedin_large' displayText='LinkedIn'></span>
	<span class='st_tumblr_large' displayText='Tumblr'></span>
	<span class='st_sharethis_large' displayText='ShareThis'></span>
	<span class='st_blogger_large' displayText='Blogger'></span>
	<span class='st_email_large' displayText='Email'></span>
</div>
<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "6e9cb968-ad78-4055-b1e7-1b7ab6751416", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

	</div>

	<!-- page link -->
    <div class="pager">
      <ul>
      
        <li class="previous"><a href="/2014/03/29/how-to-install-jekyll-in-mac-osx-mavericks" title="How To Install Jekyll in Mac OSX Mavericks">&larr; Previous</a></li>
      

      
        <li class="next"><a href="/2014/04/30/fisher-vector-in-action-recognition" title="Action Recognition with Fisher Vectors">Next &rarr;</a></li>
      
      </ul>
    </div>

	<!--
	<div class="well">
		<script>
var linkwithin_site_id = 2140443;
</script>
<script src="http://www.linkwithin.com/widget.js"></script>
<a href="http://www.linkwithin.com/"><img src="http://www.linkwithin.com/pixel.png" alt="Related Posts Plugin for WordPress, Blogger..." style="border: 0" /></a>

	</div>
	-->
    <div class="well">
		


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'boyang'; // required: replace example with your forum shortname
     var disqus_identifier = '/2014/04/18/inclusion-property';
    var disqus_url = 'http://bo-yang.github.com//2014/04/18/inclusion-property';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




    </div>
</div>

<div class="col-lg-2">
	<div class="well">
		<h4>Visitors</h4>
		<div class="tag_box">
			<script type="text/javascript" src="http://je.revolvermaps.com/2/2.js?i=493pvkdo4nt&amp;m=0&amp;s=130&amp;c=ff0000&amp;t=1" async="async"></script>
	
		</div>
    </div>

</div>




    </div>

    <footer>
        <p>&copy; 2007 <span id="now_year"></span> Bo Yang. </p>
        <script type="text/javascript">
          var now_year = new Date().getFullYear();
          if (now_year != 2007) {
              $('#now_year').html('- ' + now_year);
          }
	    </script>
      </footer>
  </div>

  <script type="text/javascript" src="/assets/google-code-prettify/prettify.js"></script>
  <script src="/assets/run_prettify.js"></script>
  <script type="text/javascript">
    $(function() {

      $('a[href^="http"]').each(function () {
        $(this).attr('target', '_blank');
      });

      $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto');
      window.prettyPrint && prettyPrint();

      function traverse($node, len, maxCount) {
        var reachMaxCount = len > maxCount;
        if (reachMaxCount) {
          $node.hide();
        }
        var $contents = $node.contents();
        for (var i = 0; i < $contents.length; ++i) {
          if (reachMaxCount) {
            $contents.eq(i).hide();
            continue;
          }
          if ($contents[i].nodeType == 3) { // TextNode
            var tmp = len;
            var s = $contents[i].nodeValue;
            len += s.length;
            reachMaxCount = len > maxCount;
            if (reachMaxCount && $contents[i].parentNode.nodeName != 'A') {
              $contents[i].nodeValue = s.substring(0, maxCount - tmp);
            }
          }
          else if ($contents[i].nodeType == 1) { // Element
            len = traverse($contents.eq(i), len, maxCount);
          }
        }
        return len;
      }

      $('.post_at_index').each(function() {
        var count = traverse($(this), 0, 400);
        if (count > 400) {
          var thisUrl = $(this).siblings().first().children().attr('href');
          $(this).after('\n<a href="' + thisUrl + '" rel="nofollow" class="btn btn-primary" role="button">' + 'Read More &raquo;</a>');
        }
      });
    });
  </script>

  

</body>
</html>

